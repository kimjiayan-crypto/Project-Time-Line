<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿé€ å·¥æœŸæ’ç¨‹ç”Ÿæˆå™¨ V8.0 </title>
    <style>
        /* --- åŸºç¤æ¨£å¼ (æ²¿ç”¨ V7) --- */
        :root {
            --primary-color: #2c3e50;
            --bg-color: #f4f4f9;
            --header-bg: #e9ecef;
            --day-width: 3px; 
            --row-height: 28px;
        }
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: var(--bg-color); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Layout */
        .app-header { background: #fff; border-bottom: 1px solid #ccc; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 45px; flex-shrink: 0; }
        .app-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); }
        .main-container { display: flex; flex: 1; overflow: hidden; height: calc(100vh - 45px); }
        .sidebar { width: 350px; background: #fff; border-right: 1px solid #ccc; overflow-y: auto; padding: 15px; flex-shrink: 0; display: flex; flex-direction: column; }
        .content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fff; }
        
        /* Form Elements */
        .form-section { margin-bottom: 12px; border: 1px solid #eee; padding: 10px; border-radius: 5px; background: #fafafa; }
        .form-section h4 { margin: 0 0 8px 0; color: #2980b9; font-size: 0.9rem; border-bottom: 1px solid #ddd; padding-bottom: 3px; }
        .form-row { display: flex; gap: 8px; margin-bottom: 6px; }
        .form-group { flex: 1; margin-bottom: 6px; }
        .form-group label { display: block; font-size: 0.75rem; font-weight: 700; color: #555; margin-bottom: 2px; }
        .form-group input, .form-group select { width: 100%; padding: 4px; border: 1px solid #bbb; border-radius: 3px; font-size: 0.85rem; box-sizing: border-box; }
        .btn-primary { background: #27ae60; color: #fff; border: none; padding: 12px; width: 100%; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem; margin-top: 10px; }
        .btn-primary:hover { background: #219150; }

        /* Gantt Chart */
        .gantt-scroll-container { flex: 1; overflow: auto; position: relative; background: #fff; }
        .gantt-chart { display: inline-block; min-width: 100%; position: relative; }
        .gantt-header-row { position: sticky; top: 0; z-index: 30; height: 35px; background: var(--header-bg); border-bottom: 1px solid #aaa; display: flex; }
        .gantt-corner { position: sticky; left: 0; z-index: 40; width: 260px; min-width: 260px; background: var(--header-bg); border-right: 2px solid #aaa; display: flex; align-items: center; padding-left: 10px; font-weight: bold; font-size: 0.85rem; }
        .gantt-timeline { flex: 1; position: relative; overflow: hidden; }
        .tick-label { position: absolute; bottom: 2px; font-size: 9px; color: #777; border-left: 1px solid #999; padding-left: 2px; height: 15px; }

        /* Rows & Bars */
        .task-row { display: flex; height: var(--row-height); border-bottom: 1px solid #eee; align-items: center; }
        .task-row:nth-child(even) { background-color: #f8f9fa; }
        .task-row:hover { background-color: #fff3cd; }
        .task-label { position: sticky; left: 0; z-index: 20; width: 260px; min-width: 260px; background: inherit; border-right: 2px solid #ddd; padding: 0 10px; font-size: 12px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: var(--row-height); font-family: 'Consolas', 'Segoe UI', sans-serif; }
        .task-bar-area { position: relative; flex-grow: 1; height: 100%; background-image: linear-gradient(to right, #eee 1px, transparent 1px); background-size: 90px 100%; }
        
        .task-bar {
            position: absolute; top: 5px; height: 18px; border-radius: 2px; 
            font-size: 10px; color: white; text-align: left; padding-left: 4px; line-height: 18px; 
            overflow: hidden; white-space: nowrap; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .task-bar:hover { z-index: 100; transform: scaleY(1.2); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }

        /* Colors */
        .cat-prep { background: #7f8c8d; }
        .cat-excav { background: #d35400; }
        .cat-struct { background: #2980b9; }
        .cat-finish { background: #16a085; }
        .cat-equip { background: #8e44ad; }
        .cat-permit { background: #27ae60; font-weight: bold; }
        .bar-hoist { background: #f39c12; color: #222; }

        /* --- V8.0 Modal Styles (å½ˆå‡ºè¦–çª—) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-box {
            background: #fff; width: 500px; max-width: 90%; max-height: 80vh;
            border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header {
            background: #2c3e50; color: #fff; padding: 15px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-close { cursor: pointer; font-size: 1.2rem; }
        .modal-body { padding: 20px; overflow-y: auto; line-height: 1.6; font-size: 0.95rem; color: #333; }
        
        /* Modal Content Styling */
        .modal-body ul { padding-left: 20px; margin: 0; }
        .modal-body li { margin-bottom: 8px; }
        .highlight-red { color: #e74c3c; font-weight: bold; }
        .note-tag { display: inline-block; background: #ecf0f1; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; color: #7f8c8d; margin-bottom: 10px; }

    </style>
</head>
<body>

<!-- Modal HTML Structure -->
<div id="infoModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-box">
        <div class="modal-header">
            <span id="modalTitle">å·¥é …èªªæ˜</span>
            <span class="modal-close" onclick="closeModalDirect()">âœ•</span>
        </div>
        <div class="modal-body" id="modalContent">
            <!-- Content Injected Here -->
        </div>
    </div>
</div>

<header class="app-header">
    <div class="app-title">ğŸ—ï¸ ç‡Ÿé€ æ’ç¨‹ç”Ÿæˆå™¨ V8.0 (çŸ¥è­˜åº«ç‰ˆ)</div>
</header>

<div class="main-container">
    <aside class="sidebar">
        <!-- Inputs (Same as V7) -->
        <div class="form-section">
            <h4>1. åŸºæœ¬èˆ‡çµæ§‹</h4>
            <div class="form-row">
                <div class="form-group"><label>å·¥æ³•</label><select id="method"><option value="CON">é †æ‰“</option><option value="INV">é€†æ‰“</option></select></div>
                <div class="form-group"><label>çµæ§‹</label><select id="structure"><option value="RC">RC</option><option value="SRC">SRC</option><option value="SS">SS</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>åœ°ä¸Š(F)</label><input type="number" id="agf" value="15"></div>
                <div class="form-group"><label>åœ°ä¸‹(B)</label><input type="number" id="bgl" value="4"></div>
            </div>
            <div class="form-group" id="inv-opt" style="display:none;"><label>é€†æ‰“è½‰æ›å±¤</label><input type="number" id="trans_fl" value="1"></div>
        </div>
        <div class="form-section">
            <h4>2. é€£çºŒå£èˆ‡é–‹æŒ–</h4>
            <div class="form-group"><label>é€£çºŒå£å–®å…ƒæ•¸</label><input type="number" id="wall_units" value="80"></div>
            <div class="form-row">
                <div class="form-group"><label>é–‹æŒ–éšæ•¸</label><input type="number" id="excav_steps" value="5"></div>
                <div class="form-group"><label>æ”¯æ’å±¤æ•¸</label><input type="number" id="brace_layers" value="4"></div>
            </div>
            <div class="form-group"><label>åœŸæ–¹æ¯æ—¥ç”¢èƒ½ (mÂ³/day)</label><input type="number" id="excav_rate" value="500"></div>
        </div>
        <div class="form-section">
            <h4>3. é¢ç©èˆ‡ç’°å¢ƒ</h4>
            <div class="form-group"><label>ç¸½æ¨“åœ°æ¿é¢ç© (mÂ²)</label><input type="number" id="area_total" value="15000"></div>
            <div class="form-group"><label>é–‹æŒ–é¢ç© (mÂ²)</label><input type="number" id="area_excav" value="1200"></div>
        </div>
        <div class="form-section">
            <h4>4. è£ä¿®èˆ‡è¨­å‚™</h4>
            <div class="form-row">
                <div class="form-group"><label>æ­£å¼é›»æ¢¯æ•¸</label><input type="number" id="elev_count" value="3"></div>
                <div class="form-group"><label>æ™¯è§€è¦æ¨¡</label><select id="landscape_type"><option value="STD">ä¸€èˆ¬</option><option value="CMPX">é‡å¤§</option></select></div>
            </div>
        </div>
        <button class="btn-primary" onclick="generateV8()">ç”Ÿæˆæ’ç¨‹è¡¨</button>
    </aside>

    <main class="content-area">
        <div class="toolbar">
            <div id="stats-display">ğŸ’¡ é»æ“Šé•·æ¢åœ–å¯æŸ¥çœ‹è©³ç´°å‚™è¨» (V8.0)</div>
            <button onclick="downloadCSV()">åŒ¯å‡ºCSV</button>
        </div>
        <div class="gantt-scroll-container">
            <div id="gantt-chart" class="gantt-chart"></div>
        </div>
    </main>
</div>

<script>
    // ==========================================
    // ğŸ› ï¸ çŸ¥è­˜åº« (KNOWLEDGE BASE) - å¯åœ¨æ­¤è™•æ›´æ–°å‚™è¨»
    // ==========================================
    const KNOWLEDGE_BASE = {
        "EXCAVATION": `
            <ul>
                <li><b>åœŸæ–¹é–‹æŒ–èƒ½é‡ï¼š</b>ç¬¬ä¸€å±¤é–‹æŒ–è‹¥æ˜¯é‹ªé¢ç”¨å’¬ç¢çš„æ–¹å¼ï¼Œæ•ˆç‡åªæœ‰ <span class="highlight-red">400æ–¹/å¤©</span>ã€‚</li>
                <li><b>é€†æ‰“ï¼š</b>å‡ºåœŸå£å—é™ï¼Œæ•ˆç‡é€šå¸¸è¼ƒé †æ‰“ä½ (ç´„70%)ã€‚</li>
                <li><b>å·¥æœŸè¨ˆç®—ï¼š</b>é«”ç© / æ—¥ç”¢èƒ½ = å·¥ä½œå¤©æ•¸ã€‚</li>
            </ul>
        `,
        "BS_STRUCT": `
            <ul>
                <li><b>é¤Šè­·æ‹†æ’é †åºï¼š</b>åœ°ä¸‹çµæ§‹æ¨“æ¿å®Œæˆå¾Œéœ€<span class="highlight-red">é¤Šè­·7å¤©</span>æ‰èƒ½æ‹†é™¤æ”¯æ’ã€‚</li>
                <li><b>è¶•å·¥ï¼š</b>è‹¥è¶•å·¥æ™‚å¯èƒ½æœƒå…ˆå£“è©¦é«”ï¼Œå¯çˆ­å–ç´„3å¤©å·¥æœŸ (å³é¤Šè­·3-4å¤©)ã€‚</li>
                <li><b>æ°´ç®±è“‹æ¿ï¼š</b>å«é¤Šè­·æŠ“ 50 å¤©ã€‚</li>
                <li><b>ä¸€èˆ¬æ¨“å±¤ï¼š</b>å«é¤Šè­·æŠ“ 40 å¤©ã€‚</li>
                <li><b>PCç‰ˆï¼š</b>æ‡‰åˆ—åœ¨ B3 (æˆ–æœ€åº•å±¤) ç‰ˆä¹‹å­éšã€‚</li>
            </ul>
        `,
        "SUPPORT": `
            <ul>
                <li><b>æ‹†é™¤æµç¨‹ï¼š</b>æ‡‰è€ƒæ…®æ™‚é–“é™åˆ¶ä»¥ç¢ºä¿å®‰å…¨æ€§ã€‚</li>
                <li><b>é™åˆ¶ï¼š</b>å¦‚ AB å€åšæ”¯æ’è¦åŒä¸€å¤©ã€‚</li>
                <li><b>æ™‚å·®ï¼š</b>æ‹†æ’æ™‚å·® 7 å¤©å…§å°šå¯æ¥å—ã€‚</li>
                <li><b>é‚è¼¯ï¼š</b>æ‹†é™¤ N å±¤æ”¯æ’å‰ï¼ŒN+1 å±¤æ¨“æ¿å¿…é ˆé¤Šè­·å®Œæˆã€‚</li>
            </ul>
        `,
        "HOIST": `
            <ul>
                <li><b>å•Ÿå‹•æ™‚æ©Ÿï¼š</b>å¾…çµæ§‹è“‹è‡³ <span class="highlight-red">3ï½4æ¨“</span> æ™‚å•Ÿå‹•å®‰è£ä½œæ¥­ã€‚</li>
                <li><b>å®‰è£ï¼š</b>7 å¤©ã€‚</li>
                <li><b>å®‰æª¢ï¼š</b>21 å¤©ã€‚</li>
                <li><b>æ‹†é™¤ï¼š</b>å¾ç¬¬ä¸€éƒ¨æ­£å¼é›»æ¢¯è£å¥½å¾Œ +50 å¤©ã€‚</li>
            </ul>
        `,
        "ELEVATOR": `
            <ul>
                <li><b>å®‰è£ç”¢èƒ½ï¼š</b>50å¤©/å°ï¼ˆä¸€çµ„äººï¼‰ã€‚</li>
                <li><b>äººåŠ›èª¿åº¦ï¼š</b>3å°ä»¥ä¸Šæ‰æœƒè«‹å…©çµ„äººã€‚</li>
                <li><b>å•Ÿå‹•æ¢ä»¶ï¼š</b>æ‡‰ä¾æ“šæ©Ÿæˆ¿å¤©èŠ±æ¿åœ¨å“ªå€‹æ¨“å±¤ï¼Œè©²æ¨“å±¤å®Œæˆå¾Œ <span class="highlight-red">21å¤©</span> æ‰èƒ½å®‰è£ã€‚</li>
            </ul>
        `,
        "FACADE": `
            <ul>
                <li><b>å·¥æœŸç¶“é©—å€¼ï¼š</b>14æ¨“çš„é‡é«”ç´„ 300~400 å¤©ï¼Œæœ€å¤š 500 å¤©ã€‚</li>
                <li><b>å•Ÿå‹•æ™‚æ©Ÿï¼š</b>ä¸€èˆ¬å¾ä¸Šæ§‹ <span class="highlight-red">7F</span> é–‹å§‹åšå¤–ç‰†ã€‚</li>
                <li><b>å…§å®¹ï¼š</b>åŒ…å«æ”¾æ¨£ã€æ³¥ä½œæ‰“åº•ã€ç£ç£š/çŸ³æã€å¡«ç¸«ã€æ¸…æ´—ç­‰ã€‚</li>
            </ul>
        `,
        "SCAFFOLD": `
            <ul>
                <li><b>20æ¨“ä»¥ä¸‹ï¼š</b>æ‹†é™¤ç´„ 30~45 å¤©ã€‚</li>
                <li><b>20æ¨“ä»¥ä¸Šï¼š</b>æ‹†é™¤ç´„ 50~60 å¤©ã€‚</li>
                <li><b>ä¸‰è§’æ¶ï¼š</b>æ‹†å›ä¸€å±¤å¤§ç´„å…©å‘¨ã€‚</li>
            </ul>
        `,
        "LANDSCAPE": `
            <ul>
                <li><b>é‡å°‘ (æ³•å®šè¦ç¯„å…§)ï¼š</b>ç´„ 30~45 å¤©ã€‚</li>
                <li><b>é‡å¤§ (ç‰¹æ®Šè¨­è¨ˆ)ï¼š</b>ä¸€èˆ¬è¦åœ¨ 1~3æ¨“å®Œæˆå¾Œæ‰èƒ½å®Œæˆï¼Œä½†æœ€å¤šä¸è¶…é 60 å¤©ã€‚</li>
                <li><b>é †åºï¼š</b>é€šå¸¸åœ¨é·¹æ¶æ‹†é™¤å¾Œé€²è¡Œï¼Œé¿å…é«˜ç©ºè½ç‰©é¢¨éšªã€‚</li>
            </ul>
        `,
        "DEFAULT": "ç„¡ç‰¹å®šå‚™è¨»ï¼Œè«‹åƒè€ƒä¸€èˆ¬å·¥ç¨‹è¦ç¯„ã€‚"
    };

    // --- V8.0 Logic ---
    const PARAMS = {
        WALL_UNIT_DAYS: 1.5, PILE_DAYS: 20, BASE_SLAB_DAYS: 50, BS_SLAB_DAYS: 40,
        HOIST_INST: 7, HOIST_INSP: 21, PERM_ELEV_PER_UNIT: 50,
    };
    const CAL_FACTOR = 7.0/6.0;

    let taskList = [];

    function addWD(start, days) { return Math.ceil(start + (days * CAL_FACTOR)); }
    
    // UI Logic
    document.getElementById('method').addEventListener('change', function(){
        document.getElementById('inv-opt').style.display = this.value==='INV'?'block':'none';
    });

    function closeModal(e) { if(e.target.id === 'infoModal') document.getElementById('infoModal').style.display = 'none'; }
    function closeModalDirect() { document.getElementById('infoModal').style.display = 'none'; }

    function showNote(kbKey, taskName) {
        const content = KNOWLEDGE_BASE[kbKey] || KNOWLEDGE_BASE["DEFAULT"];
        document.getElementById('modalTitle').innerText = taskName;
        document.getElementById('modalContent').innerHTML = `
            <span class="note-tag">åˆ†é¡ä»£ç¢¼: ${kbKey}</span>
            ${content}
        `;
        document.getElementById('infoModal').style.display = 'flex';
    }

    // --- Generator V8 ---
    function generateV8() {
        // ... (Inputs same as V7) ...
        const method = document.getElementById('method').value;
        const structure = document.getElementById('structure').value;
        const agf = parseInt(document.getElementById('agf').value);
        const bgl = parseInt(document.getElementById('bgl').value);
        const transFl = parseInt(document.getElementById('trans_fl').value) || 1;
        const wallUnits = parseInt(document.getElementById('wall_units').value) || 60;
        const excavSteps = parseInt(document.getElementById('excav_steps').value) || (bgl+1);
        const braceLayers = parseInt(document.getElementById('brace_layers').value) || bgl;
        const areaTotal = parseFloat(document.getElementById('area_total').value);
        const areaExcav = parseFloat(document.getElementById('area_excav').value);
        const excavRate = parseFloat(document.getElementById('excav_rate').value);
        const elevCount = parseInt(document.getElementById('elev_count').value);
        const landscapeType = document.getElementById('landscape_type').value;

        let areaBs = areaExcav * bgl;
        let areaTower = areaTotal - areaBs;
        if(areaTower<=0) areaTower = areaExcav * agf * 0.6;
        let stdArea = areaTower / agf;

        taskList = [];
        let t = 0;

        // Enhanced Push Function with KB Key
        const push = (name, days, cat, kbKey="DEFAULT", desc="") => {
            let s=t; let e=addWD(s, days);
            taskList.push({name, start:s, end:e, days, cat, kbKey, desc});
            return e;
        }

        // --- æ’ç¨‹é‚è¼¯ ---
        
        t = push('åŸºåœ°é»äº¤/é‘‘ç•Œ', 21, 'cat-prep');
        
        let wallDays = Math.ceil(wallUnits * PARAMS.WALL_UNIT_DAYS);
        t = push(`é€£çºŒå£ (${wallUnits}å–®å…ƒ)`, wallDays, 'cat-prep', 'DEFAULT');

        if(method === 'CON') {
            t = push('ä¸­é–“æ¨æ‰“è¨­', PARAMS.PILE_DAYS, 'cat-prep', 'DEFAULT');
            let depthAvg = 3.5;
            for(let i=1; i<=excavSteps; i++) {
                let vol = Math.round(areaExcav * depthAvg);
                let rate = (i===1) ? 400 : excavRate; // çŸ¥è­˜åº«è¦å‰‡: ç¬¬ä¸€å±¤400
                let exDays = Math.ceil(vol / rate);
                if(exDays < 5) exDays = 5;
                t = push(`ç¬¬${i}éšé–‹æŒ– (${vol}mÂ³)`, exDays, 'cat-excav', 'EXCAVATION');
                if(i <= braceLayers) {
                    t = push(`ç¬¬${i}å±¤æ”¯æ’æ–½ä½œ`, 10, 'cat-excav', 'SUPPORT');
                }
            }
            t = push('PC/å¤§åº•/æ°´ç®±è“‹æ¿', PARAMS.BASE_SLAB_DAYS, 'cat-struct', 'BS_STRUCT'); // çŸ¥è­˜åº«: æ°´ç®±50å¤©
            
            for(let b = bgl; b >= 1; b--) {
                let slabDays = (b === bgl) ? 0 : PARAMS.BS_SLAB_DAYS; 
                if(slabDays > 0) {
                    if(b < bgl) t = push(`æ‹†é™¤ B${b}å±¤æ”¯æ’`, 5, 'cat-excav', 'SUPPORT');
                    t = push(`B${b}F çµæ§‹å·¥ç¨‹`, slabDays - 7, 'cat-struct', 'BS_STRUCT');
                    t = push(`B${b}F é¤Šè­·`, 7, 'cat-struct', 'BS_STRUCT'); // çŸ¥è­˜åº«: é¤Šè­·7å¤©
                }
            }
            genSuperStruct(t, structure, transFl, agf, stdArea);
        } else {
            // é€†æ‰“ç°¡åŒ– (ä½†å¥—ç”¨çŸ¥è­˜åº«key)
            t = push('èˆŠåŸºæ¸…ç†', 30, 'cat-prep', 'DEFAULT');
            t = push('ä¸€éšé–‹æŒ–', 25, 'cat-excav', 'EXCAVATION');
            t = push(`${transFl}F è½‰æ›å±¤çµæ§‹`, 40, 'cat-struct', 'DEFAULT');
            let fork = t + 21; 
            let dt = fork;
            for(let b=1; b<=bgl; b++){
                let exD = Math.ceil((areaExcav*3.5)/(excavRate*0.7));
                let s = dt; let e = addWD(s, exD);
                taskList.push({name:`B${b}F é–‹æŒ–`, start:s, end:e, days:exD, cat:'cat-excav', kbKey:'EXCAVATION'});
                dt = e;
                e = addWD(dt, 30);
                taskList.push({name:`B${b}F çµæ§‹`, start:dt, end:e, days:30, cat:'cat-struct', kbKey:'BS_STRUCT'});
                dt = e + 10;
            }
            taskList.push({name:'å¤§åº•æ”¶å°¾', start:dt, end:dt+60, days:50, cat:'cat-struct', kbKey:'BS_STRUCT'});
            genSuperStruct(fork+15, structure, transFl, agf, stdArea, true);
        }

        // --- é€£å‹•é‚è¼¯ ---
        let structTasks = taskList.filter(x => x.cat === 'cat-struct' || x.cat === 'cat-steel');
        let f4Task = structTasks.find(t => t.name.includes('4F'));
        let time4F = f4Task ? f4Task.end : (structTasks[0].start + 60);
        let f7Task = structTasks.find(t => t.name.includes('7F'));
        let time7F = f7Task ? f7Task.end : (structTasks[0].start + 100);
        let topEnd = Math.max(...structTasks.map(t=>t.end));

        // Facade
        let facadeDur = (agf > 20) ? 500 : (agf > 14 ? 400 : 300); // çŸ¥è­˜åº«è¦å‰‡
        let facStart = time7F;
        let facEnd = addWD(facStart, facadeDur);
        taskList.push({name:'å¤–ç‰†è£ä¿®å·¥ç¨‹', start:facStart, end:facEnd, days:facadeDur, cat:'cat-finish', kbKey:'FACADE'});

        // Scaffold
        let scaffDur = (agf < 20) ? 40 : 60; // çŸ¥è­˜åº«è¦å‰‡
        let scaffStart = facEnd;
        let scaffEnd = addWD(scaffStart, scaffDur);
        taskList.push({name:'é·¹æ¶æ‹†é™¤', start:scaffStart, end:scaffEnd, days:scaffDur, cat:'cat-finish', kbKey:'SCAFFOLD'});

        // Perm Elevator
        let permElevStart = topEnd + 21; // çŸ¥è­˜åº«: æ©Ÿæˆ¿+21d
        let teams = elevCount > 3 ? 2 : 1;
        let permElevDur = Math.ceil(elevCount / teams) * 50; // çŸ¥è­˜åº«: 50d/å°
        let permElevEnd = addWD(permElevStart, permElevDur);
        taskList.push({name:`æ­£å¼é›»æ¢¯å®‰è£(${elevCount}å°)`, start:permElevStart, end:permElevEnd, days:permElevDur, cat:'cat-equip', kbKey:'ELEVATOR'});

        // Hoist
        let hoistInstStart = time4F; // çŸ¥è­˜åº«: 3-4F
        let hoistInstEnd = addWD(hoistInstStart, PARAMS.HOIST_INST + PARAMS.HOIST_INSP);
        taskList.push({name:'æ–½å·¥é›»æ¢¯å®‰è£/å®‰æª¢', start:hoistInstStart, end:hoistInstEnd, days:28, cat:'bar-hoist', kbKey:'HOIST'});
        
        let hoistRemStart = permElevEnd + 50; // çŸ¥è­˜åº«: æ­£å¼+50d
        let hoistRemEnd = addWD(hoistRemStart, 14);
        taskList.push({name:'æ–½å·¥é›»æ¢¯æ‹†é™¤', start:hoistRemStart, end:hoistRemEnd, days:14, cat:'bar-hoist', kbKey:'HOIST'});

        // Landscape
        let landDur = (landscapeType === 'CMPX') ? 60 : 40;
        let landStart = scaffEnd - 20; 
        let landEnd = addWD(landStart, landDur);
        taskList.push({name:'æ™¯è§€å·¥ç¨‹', start:landStart, end:landEnd, days:landDur, cat:'cat-finish', kbKey:'LANDSCAPE'});

        // Permit
        let fireStart = scaffEnd + 5;
        let fireEnd = addWD(fireStart, 45);
        taskList.push({name:'æ¶ˆé˜²æª¢æŸ¥', start:fireStart, end:fireEnd, days:45, cat:'cat-prep', kbKey:'DEFAULT'});
        let permitEnd = addWD(fireEnd, 60);
        taskList.push({name:'â˜… å–å¾—ä½¿ç…§', start:fireEnd, end:permitEnd, days:60, cat:'cat-permit', kbKey:'DEFAULT'});

        taskList.sort((a,b)=>a.start-b.start);
        renderV8();
    }

    function genSuperStruct(startT, struct, sF, eF, area, isParallel=false) {
        let curT = startT;
        let areaMul = 1 + Math.max(0, (area-500)/3000);
        if(struct === 'SS') {
            let curF = sF+1;
            while(curF <= eF) {
                let n = Math.min(3, eF-curF+1);
                let ed = Math.ceil(n*3);
                let e = addWD(curT, ed);
                taskList.push({name:`é‹¼æ§‹åŠè£ ${curF}-${curF+n-1}F`, start:curT, end:e, days:ed, cat:'cat-steel', kbKey:'DEFAULT'});
                let dd = Math.ceil(n*12*areaMul);
                let ds = curT + 10; let de = addWD(ds, dd);
                taskList.push({name:`Deckç‰ˆ ${curF}-${curF+n-1}F`, start:ds, end:de, days:dd, cat:'cat-struct', kbKey:'DEFAULT'});
                curT = e; curF += n;
            }
        } else {
            for(let f=sF+1; f<=eF; f++) {
                let base = (struct==='SRC')?18:14; if(f<=3) base += 3;
                let dur = Math.ceil(base * areaMul);
                let e = addWD(curT, dur);
                taskList.push({name:`${f}F çµæ§‹`, start:curT, end:e, days:dur, cat:'cat-struct', kbKey:'DEFAULT'});
                curT = e;
            }
        }
    }

    // --- Render V8 ---
    function renderV8() {
        const chart = document.getElementById('gantt-chart');
        chart.innerHTML = '';
        if(!taskList.length) return;
        
        let maxDay = Math.max(...taskList.map(t=>t.end));
        let pxPerDay = 3;
        let totalWidth = maxDay * pxPerDay + 200;

        // Header
        const hRow = document.createElement('div'); hRow.className='gantt-header-row'; hRow.style.width= (260+totalWidth)+'px';
        const cn = document.createElement('div'); cn.className='gantt-corner'; cn.textContent='å·¥é …åç¨±'; hRow.appendChild(cn);
        const tl = document.createElement('div'); tl.className='gantt-timeline';
        for(let d=0; d<=maxDay; d+=30){
            let l=document.createElement('div'); l.className='tick-label'; l.textContent=d; l.style.left=(d*pxPerDay)+'px'; tl.appendChild(l);
        }
        hRow.appendChild(tl); chart.appendChild(hRow);

        // Rows
        taskList.forEach(t => {
            let r = document.createElement('div'); r.className='task-row'; r.style.width=(260+totalWidth)+'px';
            let l = document.createElement('div'); l.className='task-label'; l.textContent=t.name; l.title=t.name; r.appendChild(l);
            let bArea = document.createElement('div'); bArea.className='task-bar-area';
            
            let bar = document.createElement('div'); bar.className=`task-bar ${t.cat}`;
            if(t.cat==='bar-hoist') bar.style.backgroundColor='#f39c12';
            bar.style.left=(t.start*pxPerDay)+'px'; bar.style.width=Math.max(2, (t.end-t.start)*pxPerDay)+'px';
            bar.textContent = `${t.days}d`;
            bar.title = `é»æ“ŠæŸ¥çœ‹å‚™è¨»`;
            
            // ğŸ”¥ CLICK EVENT
            bar.onclick = () => showNote(t.kbKey, t.name);

            bArea.appendChild(bar); r.appendChild(bArea); chart.appendChild(r);
        });
    }

    function downloadCSV() {
        let csv = "å·¥é …,åˆ†é¡,é–‹å§‹,çµæŸ,å·¥æœŸ,å‚™è¨»ä»£ç¢¼\n";
        taskList.forEach(t=>csv+=`${t.name},${t.cat},${t.start},${t.end},${t.days},${t.kbKey}\n`);
        const blob = new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='schedule_v8_kb.csv'; a.click();
    }
</script>

</body>
</html>
